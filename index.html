<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUCK-WOD ü¶Ü</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶Ü</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d0d0d;
            color: #e0e0e0;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #2a2a2a;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        h1 { color: #dc2626; font-size: 2.5em; font-weight: 800; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 24px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn:hover { background: #3a3a3a; border-color: #dc2626; }
        .tab-btn.active { background: #dc2626; color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* WOD Cards */
        .wods-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .wod-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #2a2a2a;
            transition: all 0.2s;
        }

        .wod-card:hover {
            border-color: #dc2626;
            transform: translateY(-2px);
        }

        .wod-header {
            border-bottom: 2px solid #dc2626;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .wod-source {
            font-size: 1.3em;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 5px;
        }

        .wod-date { color: #888; font-size: 0.9em; }

        /* Sections with bullets */
        .wod-section {
            margin-bottom: 20px;
            text-align: left;
        }

        .section-title {
            font-weight: 700;
            color: #dc2626;
            text-decoration: underline;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .section-lines {
            list-style: none;
            padding-left: 0;
        }

        .section-lines li {
            padding: 4px 0 4px 20px;
            position: relative;
            font-weight: normal;
        }

        .section-lines li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #dc2626;
            font-weight: bold;
        }

        /* Match score badge */
        .match-score {
            display: inline-block;
            background: #dc2626;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            margin-left: 10px;
            font-size: 0.9em;
        }

        /* Forms */
        .form-section {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            max-width: 800px;
            margin: 0 auto 30px;
        }

        .form-row {
            margin-bottom: 20px;
        }

        .form-row label {
            display: block;
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-row input {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 1em;
        }

        /* Equipment grid */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .equipment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .equipment-item:hover { background: #3a3a3a; }

        .equipment-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #dc2626;
        }

        .equipment-item label {
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }

        /* Buttons */
        .btn-primary {
            padding: 14px 28px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }

        /* Sources list */
        .sources-list {
            max-width: 900px;
            margin: 0 auto;
        }

        .source-item {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .source-info {
            flex: 1;
        }

        .source-info h3 {
            color: #dc2626;
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .source-info p {
            color: #888;
            font-size: 0.9em;
            word-break: break-all;
        }

        .source-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #4a4a4a;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active { background: #16a34a; }

        .toggle-switch .slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .slider {
            transform: translateX(30px);
        }

        .delete-btn {
            padding: 8px 16px;
            background: #7f1d1d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .delete-btn:hover { background: #991b1b; }

        .loading, .error {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 1.1em;
        }

        .error { color: #dc2626; }

        @media (max-width: 768px) {
            .wods-container { grid-template-columns: 1fr; }
            .source-item { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span style="font-size: 3em;">ü¶Ü</span>
                <h1>DUCK-WOD</h1>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('browse')">Browse Workouts</button>
                <button class="tab-btn" onclick="switchTab('find')">Find Workout</button>
                <button class="tab-btn" onclick="switchTab('sources')">Manage Sources</button>
            </div>
        </header>

        <!-- BROWSE TAB -->
        <div id="browse-tab" class="tab-content active">
            <div class="wods-container" id="wodsContainer">
                <div class="loading">Loading workouts...</div>
            </div>
        </div>

        <!-- FIND WORKOUT TAB -->
        <div id="find-tab" class="tab-content">
            <div class="form-section">
                <h2 style="color: #dc2626; margin-bottom: 25px; text-align: center;">üéØ Find Your Perfect Workout</h2>
                
                <div class="form-row">
                    <label>‚è±Ô∏è Available Time (minutes)</label>
                    <input type="number" id="findTime" min="1" max="180" value="20">
                </div>

                <div class="form-row">
                    <label>üèãÔ∏è Available Equipment (select all that apply)</label>
                    <div class="equipment-grid">
                        <label class="equipment-item">
                            <input type="checkbox" value="RUN">
                            <span>RUN</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="WALL-BALL">
                            <span>WALL-BALL</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="PULL-UP">
                            <span>PULL-UP</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="PUSH-UP">
                            <span>PUSH-UP</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="WALL-WALK">
                            <span>WALL-WALK</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="HAND-STAND PUSHUP">
                            <span>HAND-STAND PUSHUP</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="BARBELL">
                            <span>BARBELL</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="KETTLEBELL">
                            <span>KETTLEBELL</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="DUMBBELL">
                            <span>DUMBBELL</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="BIKE">
                            <span>BIKE</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="SKI">
                            <span>SKI</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="ROW">
                            <span>ROW</span>
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" value="SANDBAG">
                            <span>SANDBAG</span>
                        </label>
                    </div>
                </div>

                <button class="btn-primary" style="width: 100%; margin-top: 10px;" onclick="findWorkout()">
                    Find Best Match
                </button>
            </div>

            <div class="wods-container" id="findResults"></div>
        </div>

        <!-- MANAGE SOURCES TAB -->
        <div id="sources-tab" class="tab-content">
            <div class="form-section">
                <h2 style="color: #dc2626; margin-bottom: 25px; text-align: center;">‚ûï Add New Source</h2>
                
                <div class="form-row">
                    <label>Source Name</label>
                    <input type="text" id="newSourceName" placeholder="e.g., My CrossFit Box">
                </div>
                
                <div class="form-row">
                    <label>Source URL (must support at least 14 days archive)</label>
                    <input type="url" id="newSourceUrl" placeholder="https://example.com/wods/">
                    <small style="color: #888; display: block; margin-top: 5px;">
                        ‚ö†Ô∏è Note: URL will be validated before adding
                    </small>
                </div>
                
                <button class="btn-primary" style="width: 100%;" onclick="addSource()">
                    Add Source
                </button>
            </div>

            <div class="sources-list" id="sourcesList">
                <div class="loading">Loading sources...</div>
            </div>
        </div>
    </div>

    <script>
        let allData = null;
        let sourcesConfig = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            await loadSourcesConfig();
            displayWorkouts();
            displaySources();
        });

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // Load WODs data
        async function loadData() {
            try {
                const response = await fetch('../data/wods.json');
                allData = await response.json();
                console.log('Loaded data:', allData);
            } catch (error) {
                console.error('Error loading data:', error);
                allData = { sources: [] };
            }
        }

        // Load sources config
        async function loadSourcesConfig() {
            try {
                const response = await fetch('../data/sources.json');
                sourcesConfig = await response.json();
                console.log('Loaded sources:', sourcesConfig);
            } catch (error) {
                console.error('Error loading sources:', error);
                sourcesConfig = [];
            }
        }

        // Display workouts (Browse tab)
        function displayWorkouts() {
            const container = document.getElementById('wodsContainer');
            
            if (!allData || !allData.sources || allData.sources.length === 0) {
                container.innerHTML = '<div class="loading">No workouts available</div>';
                return;
            }

            let html = '';
            
            // Filter by enabled sources
            const enabledIds = sourcesConfig.filter(s => s.enabled).map(s => s.id);
            const enabledSources = allData.sources.filter(s => enabledIds.includes(s.id));

            if (enabledSources.length === 0) {
                container.innerHTML = '<div class="loading">No enabled sources. Please enable sources in Manage Sources tab.</div>';
                return;
            }

            // Show recent WODs from each source
            enabledSources.forEach(source => {
                const recentWods = source.wods.slice(0, 3);
                recentWods.forEach(wod => {
                    html += renderWodCard(source.name, wod);
                });
            });

            container.innerHTML = html || '<div class="loading">No workouts found</div>';
        }

        // Render a single WOD card
        function renderWodCard(sourceName, wod, matchScore = null) {
            let card = `
                <div class="wod-card">
                    <div class="wod-header">
                        <div class="wod-source">
                            ${sourceName}
                            ${matchScore ? `<span class="match-score">${matchScore}% Match</span>` : ''}
                        </div>
                        <div class="wod-date">${wod.date}</div>
                    </div>
            `;

            // Render sections with bullets
            if (wod.sections && wod.sections.length > 0) {
                wod.sections.forEach(section => {
                    card += `
                        <div class="wod-section">
                            <div class="section-title">${escapeHtml(section.title)}</div>
                            <ul class="section-lines">
                                ${section.lines.map(line => `<li>${escapeHtml(line)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
            } else {
                card += '<div class="loading">No workout data</div>';
            }

            if (wod.url) {
                card += `<a href="${wod.url}" target="_blank" style="color: #dc2626; font-weight: 600; text-decoration: none;">View Original ‚Üí</a>`;
            }

            card += `</div>`;
            return card;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== FIND WORKOUT ====================

        function findWorkout() {
            const time = parseInt(document.getElementById('findTime').value);
            const selectedEquipment = Array.from(document.querySelectorAll('.equipment-item input:checked'))
                .map(cb => cb.value);

            if (!time || selectedEquipment.length === 0) {
                alert('Please enter time and select at least one equipment type');
                return;
            }

            const results = [];
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 14);

            // Search all enabled sources
            const enabledIds = sourcesConfig.filter(s => s.enabled).map(s => s.id);
            const enabledSources = allData.sources.filter(s => enabledIds.includes(s.id));

            enabledSources.forEach(source => {
                source.wods.forEach(wod => {
                    const wodDate = new Date(wod.date);
                    if (wodDate < cutoffDate) return; // Skip old WODs

                    const score = calculateMatchScore(wod, time, selectedEquipment);
                    if (score > 0) {
                        results.push({
                            source: source.name,
                            wod: wod,
                            score: score
                        });
                    }
                });
            });

            // Sort by score (best first)
            results.sort((a, b) => b.score - a.score);

            const container = document.getElementById('findResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="error">No matching workouts found in the last 14 days.<br>Try selecting more equipment or adjusting the time.</div>';
                return;
            }

            // Show best match
            const best = results[0];
            container.innerHTML = renderWodCard(best.source, best.wod, best.score);
        }

        function calculateMatchScore(wod, targetTime, equipment) {
            let score = 0;
            
            // Combine all workout text
            const allText = wod.sections
                .map(s => s.title + ' ' + s.lines.join(' '))
                .join(' ')
                .toLowerCase();

            // Equipment keywords mapping
            const equipmentKeywords = {
                'RUN': ['run', 'running', 'meter', 'mile', 'km'],
                'WALL-BALL': ['wall ball', 'wallball', 'wall-ball'],
                'PULL-UP': ['pull-up', 'pullup', 'pull up', 'chest-to-bar', 'c2b'],
                'PUSH-UP': ['push-up', 'pushup', 'push up'],
                'WALL-WALK': ['wall walk', 'wallwalk', 'wall-walk'],
                'HAND-STAND PUSHUP': ['handstand push', 'hspu', 'hand-stand'],
                'BARBELL': ['barbell', 'clean', 'snatch', 'deadlift', 'squat', 'press', 'jerk'],
                'KETTLEBELL': ['kettlebell', 'kb'],
                'DUMBBELL': ['dumbbell', 'db'],
                'BIKE': ['bike', 'assault bike', 'echo bike', 'cal bike'],
                'SKI': ['ski', 'ski erg'],
                'ROW': ['row', 'rowing', 'rower', 'cal row'],
                'SANDBAG': ['sandbag', 'sand bag']
            };

            // Equipment matching (60% of score)
            let equipmentMatches = 0;
            equipment.forEach(eq => {
                const keywords = equipmentKeywords[eq] || [];
                if (keywords.some(kw => allText.includes(kw))) {
                    equipmentMatches++;
                }
            });

            const equipmentScore = (equipmentMatches / equipment.length) * 60;
            score += equipmentScore;

            // Time estimation (40% of score)
            const estimatedTime = estimateWorkoutTime(allText);
            const timeDiff = Math.abs(estimatedTime - targetTime);
            const timeScore = Math.max(0, 40 - (timeDiff * 1.5));
            score += timeScore;

            return Math.round(score);
        }

        function estimateWorkoutTime(text) {
            // Try to find explicit time mentions
            const timeMatch = text.match(/(\d+)\s*(min|minute)/i);
            if (timeMatch) {
                return parseInt(timeMatch[1]);
            }

            // Heuristics based on workout type
            if (/amrap/i.test(text)) {
                const amrapMatch = text.match(/amrap\s*(\d+)/i);
                return amrapMatch ? parseInt(amrapMatch[1]) : 15;
            }

            if (/emom/i.test(text)) {
                const emomMatch = text.match(/emom\s*(\d+)/i);
                return emomMatch ? parseInt(emomMatch[1]) : 15;
            }

            if (/for time/i.test(text)) {
                // Count rounds
                const roundsMatch = text.match(/(\d+)\s*round/i);
                if (roundsMatch) {
                    const rounds = parseInt(roundsMatch[1]);
                    return rounds * 3; // Estimate 3 min per round
                }
                return 20; // Default for time
            }

            // Count number of movements as rough estimate
            const movements = text.split('\n').filter(line => /\d+/.test(line)).length;
            return Math.min(movements * 2, 30);
        }

        // ==================== SOURCE MANAGEMENT ====================

        function displaySources() {
            const container = document.getElementById('sourcesList');
            
            if (sourcesConfig.length === 0) {
                container.innerHTML = '<div class="loading">No sources configured</div>';
                return;
            }

            let html = '';
            sourcesConfig.forEach((source, index) => {
                html += `
                    <div class="source-item">
                        <div class="source-info">
                            <h3>${escapeHtml(source.name)}</h3>
                            <p>${escapeHtml(source.url)}</p>
                            ${source.added_at ? `<small style="color: #666;">Added: ${new Date(source.added_at).toLocaleDateString()}</small>` : ''}
                        </div>
                        <div class="source-controls">
                            <div class="toggle-switch ${source.enabled ? 'active' : ''}" 
                                 onclick="toggleSource(${index})"
                                 title="${source.enabled ? 'Enabled' : 'Disabled'}">
                                <div class="slider"></div>
                            </div>
                            <button class="delete-btn" onclick="deleteSource(${index})">Delete</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleSource(index) {
            sourcesConfig[index].enabled = !sourcesConfig[index].enabled;
            saveSourcesConfig();
            displaySources();
            displayWorkouts(); // Refresh workout display
        }

        function deleteSource(index) {
            const source = sourcesConfig[index];
            if (confirm(`Delete source "${source.name}"?\n\nThis will remove it from the list but won't delete any fetched workouts.`)) {
                sourcesConfig.splice(index, 1);
                saveSourcesConfig();
                displaySources();
                displayWorkouts();
            }
        }

        function addSource() {
            const name = document.getElementById('newSourceName').value.trim();
            const url = document.getElementById('newSourceUrl').value.trim();

            if (!name || !url) {
                alert('Please fill in both name and URL');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('URL must start with http:// or https://');
                return;
            }

            // Generate ID
            const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '_');

            // Check if exists
            if (sourcesConfig.some(s => s.id === id)) {
                alert('A source with this name already exists');
                return;
            }

            // Add source
            sourcesConfig.push({
                id: id,
                name: name,
                url: url,
                enabled: true,
                added_at: new Date().toISOString()
            });

            saveSourcesConfig();
            displaySources();

            // Clear form
            document.getElementById('newSourceName').value = '';
            document.getElementById('newSourceUrl').value = '';

            alert(`‚úÖ Source "${name}" added successfully!\n\n‚ö†Ô∏è Note: You'll need to create a scraper module for this source to fetch workouts.\n\nSee documentation for adding custom scrapers.`);
        }

        function saveSourcesConfig() {
            // Save to localStorage (client-side only)
            // In production with backend, this would POST to API
            localStorage.setItem('duck-wod-sources', JSON.stringify(sourcesConfig));
            console.log('Sources saved to localStorage');
            
            // Note: For GitHub Pages, changes won't persist to the repo
            // You'd need to manually update data/sources.json
        }

        // Try to load from localStorage first
        async function loadSourcesConfig() {
            // Try localStorage first
            const cached = localStorage.getItem('duck-wod-sources');
            if (cached) {
                try {
                    sourcesConfig = JSON.parse(cached);
                    console.log('Loaded sources from localStorage');
                    return;
                } catch (e) {
                    console.error('Error parsing cached sources');
                }
            }

            // Fallback to JSON file
            try {
                const response = await fetch('../data/sources.json');
                sourcesConfig = await response.json();
                console.log('Loaded sources from file');
            } catch (error) {
                console.error('Error loading sources:', error);
                sourcesConfig = [];
            }
        }
    </script>
</body>
</html>
